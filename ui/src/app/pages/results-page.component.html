<div class="p-4 max-w-5xl mx-auto grid gap-4">
  <!-- Filtros -->
  <div class="card p-3 my-md">
    <div class="card-header" style="display:block; text-align:center;">
      <div class="card-title">Resultados</div>
      <div class="card-subtitle" style="display:block;">Filtra y consulta detalles de los partidos</div>
    </div>
    <div class="input-group" style="flex-wrap:wrap; justify-content:center;">
      <div class="field" style="min-width: 220px;">
        <label>Estado</label>
        <select [(ngModel)]="statusFilter" (change)="applyFilters()" class="select">
          <option value="FINISHED">Finalizados</option>
          <option value="ALL">Todos</option>
          <option value="IN_PROGRESS">En progreso</option>
          <option value="SCHEDULED">Programados</option>
        </select>
      </div>

      <div class="field" style="min-width: 260px;">
        <label>Buscar equipo</label>
        <input [(ngModel)]="q" (input)="applyFilters()" placeholder="nombre contiene…" class="input" />
      </div>
    </div>
  </div>

  <div class="grid gap-6" style="grid-template-columns: 1fr 1.6fr;">
    <!-- Lista de partidos -->
    <div class="card p-3 my-md">
      <div class="card-header">
        <div class="card-title">Partidos</div>
        <div class="card-subtitle">Coinciden con el filtro</div>
      </div>
      <div style="max-height: 400px; overflow:auto; border-radius:8px;">
        <ul class="list-clean" style="margin:0;">
          <li *ngFor="let g of filtered" style="display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.06);">
            <div>
              <div class="font-medium">{{ g.homeTeam }} vs {{ g.awayTeam }}</div>
              <div class="text-xs muted">
                Q{{ g.quarter }}
                <span class="pill" [ngClass]="{
                  'pill-finished': g.status==='FINISHED',
                  'pill-inprogress': g.status==='IN_PROGRESS',
                  'pill-scheduled': g.status==='SCHEDULED'
                }" style="margin-left:6px;">{{ g.status | lowercase | titlecase }}</span>
              </div>
            </div>
            <button class="btn btn-ghost btn-sm" (click)="view(g)">Ver</button>
          </li>
        </ul>
      </div>
    </div>

    <!-- Detalle -->
    <div *ngIf="selected as d" class="card p-3 my-md">
      <div class="card-header" style="display:flex; align-items:center; justify-content:space-between;">
        <div>
          <div class="card-title" style="margin-bottom:4px;">
            {{ d.game.homeTeam }} {{ d.game.homeScore }} - {{ d.game.awayScore }} {{ d.game.awayTeam }}
          </div>
          <div class="text-xs muted">
            Q{{ d.game.quarter }}
            <span class="pill" [ngClass]="{
              'pill-finished': d.game.status==='FINISHED',
              'pill-inprogress': d.game.status==='IN_PROGRESS',
              'pill-scheduled': d.game.status==='SCHEDULED'
            }" style="margin-left:6px;">{{ d.game.status | lowercase | titlecase }}</span>
          </div>
        </div>

        <!-- BONUS por equipo en el cuarto actual -->
        <div class="text-sm" style="display:flex; align-items:center; gap:10px;">
          <div>
            HOME Q{{ d.game.quarter }}: <strong>{{ (foulSummary?.team | teamFouls:'HOME':d.game.quarter) }}</strong>
            <span *ngIf="(foulSummary?.team | isBonus:'HOME':d.game.quarter)" class="ml-2 px-2 py-0.5 bg-red-600 text-white rounded text-xs">BONUS</span>
          </div>
          <div class="opacity-40">|</div>
          <div>
            AWAY Q{{ d.game.quarter }}: <strong>{{ (foulSummary?.team | teamFouls:'AWAY':d.game.quarter) }}</strong>
            <span *ngIf="(foulSummary?.team | isBonus:'AWAY':d.game.quarter)" class="ml-2 px-2 py-0.5 bg-red-600 text-white rounded text-xs">BONUS</span>
          </div>
        </div>
      </div>

      <!-- Alerta visual de partido finalizado (detalle) -->
      <div *ngIf="d.game.status==='FINISHED'" style="
        background: rgba(34,197,94,0.15);
        border: 1px solid rgba(34,197,94,0.35);
        color: #bbf7d0;
        padding: 10px 12px;
        border-radius: 8px;
        margin: 10px 0;
        font-weight: 600;">
        Partido finalizado
      </div>

      <div class="stack-md">
      <div class="card p-3">
        <div class="card-header">
          <div class="card-title">Eventos recientes</div>
          <div class="card-subtitle">Actividad del juego (cronológico)</div>
        </div>
        <ul class="text-sm" style="max-height:16rem; overflow:auto; border-radius:8px;">
          <li *ngFor="let e of d.events" style="padding:6px 12px; border-bottom:1px solid rgba(255,255,255,0.06);">
            {{ e.createdAt | date:'short' }} — {{ e.eventType }}
            <ng-container *ngIf="e.team">({{ e.team }})</ng-container>
            <ng-container *ngIf="e.playerNumber != null"> #{{ e.playerNumber }}</ng-container>
            <ng-container *ngIf="e.playerId != null"> (id: {{ e.playerId }})</ng-container>
          </li>
        </ul>
      </div>

      <div class="grid gap-4 p-3 my-md" style="grid-template-columns: 1fr 1fr;">
        <!-- Plantilla HOME -->
        <div class="card p-3">
          <div class="card-header" style="display:flex; align-items:center; justify-content:space-between;">
            <span *ngIf="(foulSummary?.team | isBonus:'HOME':d.game.quarter)" class="ml-2 px-2 py-0.5 bg-red-600 text-white rounded text-xs">BONUS</span>
          </div>
          <table class="w-full text-sm" style="border-collapse:separate; border-spacing:0 6px;">
            <thead>
              <tr class="text-left" style="background:rgba(59,130,246,0.12);">
                <th style="width:3rem;">#</th>
                <th>Jugador</th>
                <th style="width:3rem; text-align:center;">Q1</th>
                <th style="width:3rem; text-align:center;">Q2</th>
                <th style="width:3rem; text-align:center;">Q3</th>
                <th style="width:3rem; text-align:center;">Q4</th>
                <th style="width:3.5rem; text-align:center;">Total</th>
                <th style="width:3.5rem;"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let p of homeRoster" style="background:rgba(255,255,255,0.03);">
                <td>{{ p.number ?? '—' }}</td>
                <td>{{ p.name }}</td>
                <td style="text-align:center;">{{ (foulSummary?.players | playerFoulsQ:'HOME':p.playerId:1) }}</td>
                <td style="text-align:center;">{{ (foulSummary?.players | playerFoulsQ:'HOME':p.playerId:2) }}</td>
                <td style="text-align:center;">{{ (foulSummary?.players | playerFoulsQ:'HOME':p.playerId:3) }}</td>
                <td style="text-align:center;">{{ (foulSummary?.players | playerFoulsQ:'HOME':p.playerId:4) }}</td>
                <td style="text-align:center; font-weight:600;">
                  {{ (foulSummary?.players | playerFoulsTotal:'HOME':p.playerId) }}
                </td>
                <td>
                  <span *ngIf="outSet.has(p.playerId)" class="ml-2 px-2 py-0.5 bg-black text-white rounded">OUT</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Plantilla AWAY -->
        <div class="card p-3 my-md">
          <div class="card-header" style="display:flex; align-items:center; justify-content:space-between;">
            <span *ngIf="(foulSummary?.team | isBonus:'AWAY':d.game.quarter)" class="ml-2 px-2 py-0.5 bg-red-600 text-white rounded text-xs">BONUS</span>
          </div>
          <table class="w-full text-sm" style="border-collapse:separate; border-spacing:0 6px;">
            <thead>
              <tr class="text-left" style="background:rgba(59,130,246,0.12);">
                <th style="width:3rem;">#</th>
                <th>Jugador</th>
                <th style="width:3rem; text-align:center;">Q1</th>
                <th style="width:3rem; text-align:center;">Q2</th>
                <th style="width:3rem; text-align:center;">Q3</th>
                <th style="width:3rem; text-align:center;">Q4</th>
                <th style="width:3.5rem; text-align:center;">Total</th>
                <th style="width:3.5rem;"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let p of awayRoster" style="background:rgba(255,255,255,0.03);">
                <td>{{ p.number ?? '—' }}</td>
                <td>{{ p.name }}</td>
                <td style="text-align:center;">{{ (foulSummary?.players | playerFoulsQ:'AWAY':p.playerId:1) }}</td>
                <td style="text-align:center;">{{ (foulSummary?.players | playerFoulsQ:'AWAY':p.playerId:2) }}</td>
                <td style="text-align:center;">{{ (foulSummary?.players | playerFoulsQ:'AWAY':p.playerId:3) }}</td>
                <td style="text-align:center;">{{ (foulSummary?.players | playerFoulsQ:'AWAY':p.playerId:4) }}</td>
                <td style="text-align:center; font-weight:600;">
                  {{ (foulSummary?.players | playerFoulsTotal:'AWAY':p.playerId) }}
                </td>
                <td>
                  <span *ngIf="outSet.has(p.playerId)" class="ml-2 px-2 py-0.5 bg-black text-white rounded">OUT</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div> <!-- /grid plantillas en cards -->
      </div>
    </div>
  </div>
</div>
