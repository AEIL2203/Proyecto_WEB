<!-- Barra de navegación -->
<app-navigation-bar (sectionChange)="onSectionChange($event)"></app-navigation-bar>

<!-- Panel de información del usuario (solo si está autenticado) -->
<div class="user-info-panel" *ngIf="getCurrentUser()">
  <div class="container">
    <div class="user-welcome">
      <span class="user-greeting">👋 Bienvenido, <strong>{{ getCurrentUser()?.userName }}</strong></span>
      <span class="user-role" [class.admin-role]="isAdmin()">
        {{ isAdmin() ? '👑 Administrador' : '👤 Usuario' }}
      </span>
      <div class="admin-actions" *ngIf="isAdmin()">
        <a routerLink="/admin/users" class="admin-link">
          👥 Ver Usuarios
        </a>
        <a routerLink="/admin/register-user" class="admin-link">
          ➕ Registrar Usuario
        </a>
        <button (click)="logout()" class="logout-btn">
          🚪 Cerrar Sesión
        </button>
      </div>
    </div>
  </div>
</div>

<div class="p-4">

  <!-- Sección: Crear Partidos -->
  <section class="container" *ngIf="activeSection === 'games'">
    <app-section-header 
      icon="🏀" 
      title="Gestión de Partidos" 
      description="Crear enfrentamientos y administrar partidos en tiempo real">
    </app-section-header>
    
    <div class="grid-2-14-20">
      <!-- Crear partido -->
      <div class="card p-3">
        <div class="card-header center">
          <div class="card-title">Crear un partido</div>
          <div class="card-subtitle">Crear un nuevo partido entre equipos</div>
        </div>
        
        <div class="input-group mb-10">
          <div class="field" style="flex:1; min-width:200px;">
            <label>Equipo local</label>
            <select #homeSel class="select">
              <option [value]="0">Seleccionar equipo local</option>
              <option *ngFor="let t of teams" [value]="t.teamId">{{ t.name }}</option>
            </select>
          </div>
        </div>
        
        <div class="input-group" style="margin-bottom: 10px;">
          <div class="field" style="flex:1; min-width:200px;">
            <label>Equipo visitante</label>
            <select #awaySel class="select">
              <option [value]="0">Seleccionar equipo visitante</option>
              <option *ngFor="let t of teams" [value]="t.teamId">{{ t.name }}</option>
            </select>
          </div>
        </div>
        
        <div class="input-group" style="margin-bottom: 10px;">
          <div class="field" style="flex:1; min-width:200px;">
            <label>Duración del cuarto</label>
            <select [(ngModel)]="selectedQuarterMs" class="select">
              <option [value]="10000">10 segundos</option>
              <option [value]="300000">5 minutos</option>
              <option [value]="600000">10 minutos</option>
              <option [value]="720000">12 minutos</option>
            </select>
          </div>
        </div>
        
        <div class="centered-row" style="margin-bottom: 8px;">
          <button
            class="btn btn-success"
            [disabled]="creating"
            (click)="createGame(+homeSel.value, +awaySel.value)"
            class="btn-success btn-wide">
            {{ creating ? 'Creando…' : 'Crear partido' }}
          </button>
        </div>
      </div>

      <!-- Lista de partidos -->
      <div class="card p-3">
        <div class="card-header" style="display:block; text-align:center;">
          <div class="card-title" style="margin-bottom: 4px;">Partidos existentes</div>
          <div class="card-subtitle" style="display:block;">Los últimos 50 partidos</div>
        </div>
        <div class="list-scroll">
          <ul class="list-clean text-sm" style="margin:0;">
            <li *ngFor="let g of games | slice:0:50" class="list-item-row">
              <div style="flex: 1;">
                <div class="font-medium">{{ g.homeTeam }} vs {{ g.awayTeam }}</div>
                <div class="text-xs muted">Cuarto {{ g.quarter }} • {{ g.homeScore }}-{{ g.awayScore }}</div>
              </div>
              <div class="row" style="gap: 0.5rem; flex-wrap: wrap;">
                <span class="pill text-xs"
                      [ngClass]="{
                        'pill-finished': g.status==='FINISHED',
                        'pill-inprogress': g.status==='IN_PROGRESS',
                        'pill-scheduled': g.status==='SCHEDULED'
                      }">
                  {{ g.status | lowercase | titlecase }}
                </span>
                <div class="row" style="gap: 0.25rem;">
                  <button class="btn btn-ghost btn-sm"
                          [routerLink]="['/display', g.gameId]"
                          title="Ver solo marcador">
                    📊 Marcador
                  </button>
                  <button class="btn btn-ghost btn-sm"
                          [routerLink]="['/controls', g.gameId]"
                          title="Abrir Panel de control">
                    🎮 Controles
                  </button>
                  <button class="btn btn-ghost btn-sm" 
                          [routerLink]="['/results']" 
                          [queryParams]="{ id: g.gameId }"
                          title="Ver resultados completos">
                    📋 Estadísticas
                  </button>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>



    <!-- Vista solo Marcador -->
    <div class="card p-3" *ngIf="detail && viewMode === 'scoreboard'">
      <div class="card-header center" style="margin-bottom: 1rem;">
        <div class="card-title">📊 Marcador del Partido</div>
        <div class="card-subtitle">{{ detail.game.homeTeam }} vs {{ detail.game.awayTeam }}</div>
      </div>
      <app-scoreboard [game]="detail.game"></app-scoreboard>
      
      <div class="mt-4 center">
        <button class="btn btn-ghost" (click)="closeDetail()">
          ← Volver a la lista
        </button>
      </div>
    </div>

    <!-- Vista Controles Completos -->
    <div class="card p-3" *ngIf="detail && viewMode === 'controls'">
      <div class="card-header center" style="margin-bottom: 1rem;">
        <div class="card-title">🎮 Panel de Control</div>
        <div class="card-subtitle">{{ detail.game.homeTeam }} vs {{ detail.game.awayTeam }}</div>
      </div>
      
      <app-scoreboard [game]="detail.game"></app-scoreboard>

      <!-- Panel de control centrado -->
      <div class="mt-4 controls-center">
        <div class="controls-container">
          <app-control-panel [game]="detail.game" (changed)="view(detail.game.gameId)"></app-control-panel>
        </div>
      </div>

      <!-- Cronómetro en bloque aparte full-width -->
      <div class="mt-5 card p-3">
        <app-clock
          [gameId]="detail.game.gameId"
          [status]="detail.game.status"
          [quarter]="detail.game.quarter"
          [showTeamFouls]="false"
          (expired)="onExpire()">
        </app-clock>
      </div>

      <div class="mt-5 rosters-grid">
        <div class="card p-3 roster-card">
          <app-team-roster [gameId]="detail.game.gameId" side="HOME"></app-team-roster>
        </div>
        <div class="card p-3 roster-card">
          <app-team-roster [gameId]="detail.game.gameId" side="AWAY"></app-team-roster>
        </div>
      </div>
      
      <div class="mt-4" style="text-align: center;">
        <button class="btn btn-ghost" (click)="closeDetail()">
          ← Volver a la lista
        </button>
      </div>
    </div>
</section>

  <!-- Sección: Crear Equipos -->
  <section class="container" *ngIf="activeSection === 'teams'">
    <app-section-header 
      icon="👥" 
      title="Gestión de Equipos" 
      description="Crear y administrar equipos del sistema">
    </app-section-header>
    <div class="grid-2">
      <!-- Crear equipo -->
      <div class="card p-3">
        <div class="card-header" style="display:block; text-align:center;">
          <div class="card-title">Crear equipo</div>
          <div class="card-subtitle">Agregar un nuevo equipo al sistema</div>
        </div>
        <div class="input-group mb-10">
          <div class="field" style="flex:1; min-width:260px;">
            <label>Nombre del equipo</label>
            <input [(ngModel)]="newTeamName" placeholder="Ej. Los Tilines" class="input" />
            <div class="text-xs" style="margin-top:4px;">
              * Solo letras y espacios.
              <span *ngIf="newTeamName.trim() && !isTeamNameValid(newTeamName)" style="color:#f87171;">Nombre inválido.</span>
            </div>
          </div>
        </div>
        <div class="input-group" style="margin-bottom: 10px;">
          <div class="field" style="flex:1; min-width:260px;">
            <label>Ciudad</label>
            <input [(ngModel)]="newTeamCity" placeholder="Ej. Ciudad de Guatemala" class="input" />
          </div>
        </div>
        <!-- Logo del equipo: arrastrar y soltar o seleccionar archivo -->
        <div class="input-group" style="margin-bottom: 10px;">
          <div class="field" style="flex:1; min-width:260px;">
            <label>Logo del equipo (opcional)</label>
            <div
              (drop)="onLogoDrop($event)"
              (dragover)="onLogoDragOver($event)"
              (dragleave)="onLogoDragLeave($event)"
              style="border: 2px dashed rgba(255,255,255,0.2); border-radius: 10px; padding: 14px; text-align:center; cursor:pointer; background: rgba(255,255,255,0.02);">
              <div *ngIf="!newTeamLogoPreviewUrl" class="text-sm dropzone-help">
                Arrastra y suelta una imagen aquí, o
                <label style="color:#60a5fa; text-decoration: underline; cursor: pointer;">
                  selecciona un archivo
                  <input type="file" accept="image/*" (change)="onLogoFileSelected($event)" style="display:none;" />
                </label>
              </div>
              <div *ngIf="newTeamLogoPreviewUrl" class="preview-row">
                <img [src]="newTeamLogoPreviewUrl" alt="preview" class="preview-img" />
                <button type="button" class="btn btn-ghost" (click)="clearNewTeamLogo()">Quitar</button>
              </div>
              <div class="text-xs muted" style="margin-top:6px;">Formatos: PNG, JPG, WEBP, SVG. Máx 5 MB.</div>
            </div>
          </div>
        </div>
        <div class="centered-row" style="margin-bottom: 8px;">
          <button class="btn btn-success btn-wide"
                  [disabled]="creating || !isTeamNameValid(newTeamName)"
                  (click)="createTeam()">
            {{ creating ? 'Creando…' : 'Crear equipo' }}
          </button>
        </div>
      </div>

      <!-- Lista de equipos -->
      <div class="card p-3">
        <div class="card-header" style="display:block; text-align:center;">
          <div class="card-title" style="margin-bottom: 4px;">Equipos existentes</div>
          <div class="card-subtitle" style="display:block;">En orden alfabético</div>
        </div>
        <div class="input-group" style="margin-top: 6px; margin-bottom: 6px;">
          <div class="field" style="flex:1; min-width:200px;">
            <input [(ngModel)]="teamsQuery" class="input" placeholder="Buscar equipo o #ID" />
          </div>
        </div>
        <div class="list-scroll-sm">
          <ul class="list-clean text-sm" style="margin:0;">
            <li *ngFor="let t of filteredTeams" class="list-item-row">
              <!-- Modo lectura -->
              <div *ngIf="editingTeamId !== t.teamId; else editTpl" class="row team-list-item">
                <div class="row">
                  <img [src]="teamLogoUrl(t.teamId)"
                       alt="logo"
                       (error)="onTeamLogoError($event)"
                       class="team-logo-sm" />
                  <div>
                    <div>{{ t.name }}</div>
                    <div class="text-xs" *ngIf="t.city" style="opacity:.8;">{{ t.city }}</div>
                  </div>
                </div>
                <div class="row-end ml-auto">
                  <span class="text-xs pill pill-accent">#{{t.teamId}}</span>
                  <button class="btn btn-sm btn-edit" (click)="startEditTeam(t)">Editar</button>
                  <button class="btn btn-sm btn-danger" (click)="deleteTeam(t)">Eliminar</button>
                </div>
              </div>
  
              <!-- Modo edición -->
              <ng-template #editTpl>
                <div class="card" style="padding:10px; background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:8px;">
                  <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="field">
                      <label>Nombre</label>
                      <input class="input" [(ngModel)]="editTeamName" />
                      <div class="text-xs" style="margin-top:4px;">
                        <span *ngIf="editTeamName.trim() && !isTeamNameValid(editTeamName)" style="color:#f87171;">Nombre inválido.</span>
                      </div>
                    </div>
                    <div class="field">
                      <label>Ciudad</label>
                      <input class="input" [(ngModel)]="editTeamCity" />
                    </div>
                    <div class="field" style="grid-column: 1 / -1;">
                      <label>Logo</label>
                      <div class="row">
                        <img *ngIf="editLogoPreviewUrl; else currentLogo"
                             [src]="editLogoPreviewUrl"
                             alt="preview"
                             class="team-logo-md" />
                        <ng-template #currentLogo>
                          <img [src]="teamLogoUrl(t.teamId)"
                               alt="logo"
                               (error)="onTeamLogoError($event)"
                               class="team-logo-md" />
                        </ng-template>
                        <input type="file" accept="image/*" (change)="onEditLogoSelected($event)" />
                      </div>
                    </div>
                  </div>
                  <div class="row-end" style="justify-content:flex-end; gap:8px; margin-top:10px;">
                    <button class="btn btn-secondary btn-sm btn-edit ml-auto" (click)="cancelEditTeam()">Cancelar</button>
                    <button class="btn btn-primary btn-sm" [disabled]="!isTeamNameValid(editTeamName)" (click)="saveEditTeam()">Guardar</button>
                  </div>
                </div>
              </ng-template>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- Sección: Gestionar Jugadores -->
  <section class="container" *ngIf="activeSection === 'players'">
    <app-section-header 
      icon="⚽" 
      title="Gestión de Jugadores" 
      description="Administrar plantillas y jugadores por equipo">
    </app-section-header>
    
    <div class="card p-3">
      <app-admin-team-roster></app-admin-team-roster>
    </div>
  </section>

</div>

